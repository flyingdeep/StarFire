<!doctype html>
<html>
<head>

    <title>找摊位</title>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=0">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <META HTTP-EQUIV="Pragma" CONTENT="no-cache">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <link rel="stylesheet" type="text/css" href="framework/appframework-master/build/icons.css" />
    <link rel="stylesheet" type="text/css" href="framework/appframework-master/build/af.ui.css" />
    <link rel="stylesheet" type="text/css" href="css/customize.css" />

    <script type="text/javascript" src="./js/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" charset="utf-8" src="./js/fastclick.js"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/api?type=quick&ak=NpZPLFzDKjPWEenu8D2yf4vS&v=1.0"></script>

    <script type="text/javascript" src="./js/baidu/initial.js"></script>
    <script type="text/javascript" src="./js/config.js"></script>
    <script type="text/javascript" src="./js/messages.js"></script>
    <script type="text/javascript" src="./js/class/remoteProxy.js"></script>
    <script type="text/javascript" src="./js/class/processFacade.js"></script>
    <script type="text/javascript" src="./js/class/commonHelper.js"></script>
    <script type="text/javascript" src="./js/baidu/lbscloud.js"></script>
    <script type="text/javascript" src="./js/baidu/maphelper.js"></script>
    <script type="text/javascript" src="./js/common/imageUploadHelper.js"></script>



    <script type="text/javascript" charset="utf-8" src="framework/appframework-master/src/af.shim.js"></script>
    <script type="text/javascript" charset="utf-8" src="framework/appframework-master/src/af.ui.js"></script>

    <script type="text/javascript" charset="utf-8" src="framework/appframework-master/src/af.desktopBrowsers.js"></script>
    <script type="text/javascript" charset="utf-8" src="framework/appframework-master/src/af.actionsheet.js"></script>
    <script type="text/javascript" charset="utf-8" src="framework/appframework-master/src/af.animation.js"></script>
    <script type="text/javascript" charset="utf-8" src="framework/appframework-master/src/af.touchEvents.js"></script>
    <script type="text/javascript" charset="utf-8" src="framework/appframework-master/src/af.popup.js"></script>
    <script type="text/javascript" charset="utf-8" src="framework/appframework-master/src/af.drawer.js"></script>
    <script type="text/javascript" charset="utf-8" src="framework/appframework-master/src/af.toast.js"></script>
    <script type="text/javascript" charset="utf-8" src="framework/appframework-master/src/af.animateheader.js"></script>
    <script type="text/javascript" charset="utf-8" src="framework/appframework-master/src/af.splashscreen.js"></script>
    <script type="text/javascript" charset="utf-8" src="framework/appframework-master/src/af.swipereveal.js"></script>



    <script type="text/javascript">
        $.afui.useOSThemes=false;
        $.afui.loadDefaultHash=true;
        $.afui.autoLaunch=false;
        var commonHelper = new commonHelperClass();
        $(document).ready(function(){


            initialAction();

        });

        function initialAction()
        {
            FastClick.attach( document.body );
            $.afui.launch();
            $.afui.manageHistory=false;
            currentPanel = "#mapPanel";
        }
        var mapCenterString = null; //map center val



        //************************************ main map related**************************************
        var gc = new BMap.Geocoder();
        var mapCr =null;
        var map = null;


    </script>


</head>
<body>
<!----------------------   Main Map View --------------------->
<div class="view" id="mainView">
    <header id="mapHeader">
        <div style="float:left"><a onclick="" class="icon info green button previous">个人信息</a></div>

        <div style="float:right"><a onclick='transferToPanel("#standListPanel","slide");' class="icon right green button next">摊位列表</a></div>
       <div class="titleDiv">摊位地图</div>
    </header>
    <div class="pages">

          <div class="panel zeroPadding"  id="mapPanel" data-selected="true">
              <div id="searchBar">
                  <div id="searchDiv"><form id="searchForm"><input id="searchInput" type="search" placeholder="搜索摊位"></form></div>
                  <div id="toggleDiv"><input id="toggleTarget" type="checkbox" checked=""  name="toggleTarget" value="1" class="toggle">
                  <label for="toggleTarget"  data-on="摊位" data-off="地址" class="toggleLabel"><span></span>
                  </label><br style="clear:both"></div>
                  <a  class="button smallButton mapHintButton" id="filterSettingIcon">筛选</a><br style="clear:both">
                  <a  class="button smallButton mapHintButton" id="closeSearchResult">完成</a>
              </div>
              <div id="bottomBar">
              <div id="transparentShader"></div>
                  <div class="button-grouped">
                 <a  onclick='transferToPanel("#createStandPanel1","pop");' class="button  icon add" >新增摊位</a>
                      <a href="#" class="button  icon folder">我的摊位</a>
                      <a href="#" class="button  icon heart">我的收藏</a>
                      </div>
              </div>

           <div id="mapContainer" class="mapCss"></div>
          </div>
    </div>

</div>
<!----------------------  附近摊位列表 --------------------->
<div class="view" id="nearbyStandListView">
    <header id="standListHeader" >
        <div style="float:left"><a onclick='transferToPanel("#mapPanel","up");' class="icon info green button previous">返回地图</a></div>

        <div style="float:right;margin-right: 10px"><a class="button" id="filterSettingIcon_nearbyStandListView">筛选</a>
            </div>
        <div class="titleDiv">摊位列表</div>
    </header>
    <div class="pages">
        <div class="panel"  id="standListPanel">
            <div id="standList">


            </div>
        </div>
    </div>


</div>

<!----------------------  搜索结果 --------------------->
<div class="view" id="searchResultListView">
    <header id="searchResultHeader" >
        <div style="padding:5px;">
            <form id="searchResultListForm">
                <div id="searchDivResultInner"><input  type="search" placeholder="搜索" style="color:black;"></div>
            </form>
        </div>
    </header>
    <div class="pages">
        <div class="panel"  id="searchResultListPanel">
                <div id="resultList">


                </div>
        </div>
    </div>


</div>

<!----------------------   创建摊位 - 1 --------------------->
<div class="view" id="createStandView1">
    <header id="createStandHeader1">
        <div style="float:left"><a onclick='transferToPanel("#mapPanel","up");'  class="icon close green button previous">放弃</a></div>
        <div style="float:right"><a onclick='transferToPanel("#createStandPanel2","slide");' class="icon right green button next">下一步</a></div>
        <div class="titleDiv">新建摊位-基本信息</div>
    </header>
    <div class="pages">
        <div class="panel panelPadding"  id="createStandPanel1">

            <form>
                    <div>摊位名:</div><br>
                    <div><input id="standName" type="text" placeholder="不超过十个字"></div>
                    <div>类型:</div>
                <div id="standTypeDiv" class="grid"></div><br>
                    <div>子分类:</div><br>
                <div><input id="subStandType" type="text" placeholder="多子分类以逗号隔开。 如： 蛋饼，葱油饼，臭豆腐
"></div>
                    <div>描述:</div><br>
                <div><textarea id="test3" rows="6" placeholder="描述摊位特色，来由或任何细节信息，不超过200字
"></textarea></div>
            </form>
        </div>
     </div>


</div>
<!----------------------   创建摊位 - 2 --------------------->
<div class="view" id="createStandView2">
    <header id="createStandHeader2">
        <div style="float:left"><a onclick='transferToPanel("#createStandPanel1","invoke");'   class="icon left green button previous">上一步</a></div>
        <div style="float:right"><a onclick='transferToPanel("#createStandPanel3","slide");' class="icon right green button next">下一步</a></div>
        <div class="titleDiv">新建摊位-选择位置</div>
    </header>
    <div class="pages">
        <div class="panel zeroPadding"  id="createStandPanel2">
            <div style="position: absolute;top:3px;width:100%;left:2px;z-index: 50" >
                <form id="map2SearchForm">
                    <div id="searchDivInner" style="float:left; width:95%"><input  type="search" placeholder="搜索地址以定位区域"></div>
                </form>
                <br style="clear:both">
                <a  class="button smallButton mapHintButton" id="setCurrentPosition">设置为当前位置</a>
            </div>
            <div id="mapContainerCr" class="mapCss"></div>
        </div>
    </div>


</div>

<!----------------------   创建摊位 - 3 --------------------->
<div class="view" id="createStandView3">
    <header id="createStandHeader3">
        <div style="float:left"><a onclick='transferToPanel("#createStandPanel2","invoke");' data-transition="invoke"  class="icon left green button previous">上一步</a></div>
        <div style="float:right"><a href="#" data-transition="slide" class="icon right green button next">完成</a></div>
        <div class="titleDiv">新建摊位-摊位图片</div>
    </header>
    <div class="pages">
        <div class="panel zeroPadding"  id="createStandPanel3">
            <div>
                <form>
                    <a class="button smallButton" onclick="$('#file').click();" >选择并上传图片</a>
                    <input style="visibility: visible;" id="file" name="file" type="file" accept="image/jpeg,image/png" >

                </form>
            </div>
            <div id="standImageContainer">

            </div>


        </div>
    </div>


</div>

<!---------------------  右侧菜单  -------------------------------->
<nav id="right_Filter" style="width:90%">
<div class="view active">
    <header>
        <a data-menu-close class="button previous" style="float:left;">关闭</a>
        <h1>筛选设置</h1>
    </header>
    <div class="pages">
        <div class="panel active" id="filterPanel">

                <div  class="grid">
                    <div class="gcol2 filterLineCss">显示距离:</div><div class="gcol2 filterLineCss">&nbsp;</div>
                    <div class="gcol2"><input id="distantRadio200" type="radio"  name="distantRadio" value="200"><label for="distantRadio200">200米</label></div>
                    <div class="gcol2"><input id="distantRadio500" type="radio"  name="distantRadio" value="500" selected><label for="distantRadio500">500米</label></div>
                    <div class="gcol2"><input id="distantRadio1000" type="radio"  name="distantRadio" value="1000"><label for="distantRadio1000">1000米</label></div>
                    <div class="gcol2"><input id="distantRadio2000" type="radio"  name="distantRadio" value="2000"><label for="distantRadio2000">2000米</label></div>
                    &nbsp;
                </div><br />

                <div  class="grid">
                    <div class="gcol2 filterLineCss">摊位类型过滤:</div><div class="gcol2 filterLineCss">&nbsp;</div>
                   <div id="standTypeFilterContainer"></div>
                    <br /> &nbsp;
                </div><br />
               <div id="toggleCustomCrStandDiv" class="grid">
                   <div class="gcol2 filterLineCss">显示非摊主创建摊位:</div>
                   <div class="gcol2 filterLineCss">
                       <input id="toggleCustomCrStandInput" type="checkbox" name="toggleCustomCrStandInput" value="1" class="toggle">
                    <label for="toggleCustomCrStandInput"  data-on="是" data-off="否"><span></span></label>
                    </div>
                </div>
                <div id="toggleFavoriteStandDiv" class="grid">
                    <div class="gcol2 filterLineCss">仅显示收藏摊位:</div>
                    <div class="gcol2 filterLineCss"><input id="toggleFavoriteStandInput" type="checkbox" name="toggleFavoriteStandInput" value="1" class="toggle">
                    <label for="toggleFavoriteStandInput"  data-on="是" data-off="否"><span></span></label>
                    </div>
                </div>
              <!--   <div id="standDisplayModeDiv" class="grid" >
                     <div class="gcol2 filterLineCss">自动显示周边摊位:</div>
                     <div class="gcol2 filterLineCss" >
                     <input id="standDisplayModeInput" type="checkbox" name="standDisplayModeInput" value="1" class="toggle">
                    <label for="standDisplayModeInput"  data-on="是" data-off="否"><span></span></label>
                     </div>
                </div> -->

        </div>
    </div>
</div>
</nav>

<script type="text/javascript">
    $("#toggleTarget").on("change",function()
    {
        if ($("#toggleTarget").prop("checked"))
        {
            $("#searchInput").prop("placeholder","搜索摊位");
        }
        else
        {
            $("#searchInput").prop("placeholder","搜索地址");
        }
    });
    $("#searchForm").on("submit",function()
    {
        if ($("#toggleTarget").prop("checked"))
        {
            searchStand(map);
        }
        else
        {
            searchLocation(map);
        }
        return false;
    });

    $("#map2SearchForm").on("submit",function()
    {
            searchSecLocation(mapCr);

        return false;
    });

    $("#filterPanel").on("swipeRight", function(){
        $.afui.drawer.hide("#right_Filter","right");
    });


    var toastObj = null;
    $("#createStandPanel1").on("panelbeforeload",function(){

        if ( $("#standTypeDiv").html() == "") {
            if (!staticStandTypeHtmlString) {
                commonHelper.constructStandTypeHTML(function (e) {

                    $("#standTypeDiv").html(e);
                    staticStandTypeHtmlString = e;
                }, "crStandType_");
            }
            else {
                $("#standTypeDiv").html(staticStandTypeHtmlString);

            }
        }

    });

    $("#filterSettingIcon").on("click",function(){

                if ( $("#standTypeFilterContainer").html() == "") {
                    var innerHtmlStr = '<div class="gcol2"><input id="filterStandType_all" type="radio"  name="filterStandType_Radio" value="0"><label for="filterStandType_all">所有类型</label></div>';
                    if (!staticStandTypeHtmlString) {
                        commonHelper.constructStandTypeHTML(function (e) {
                            $("#standTypeFilterContainer").html(innerHtmlStr+e);
                            staticStandTypeHtmlString = e;
                        }, "filterStandType_");
                    }
                    else {
                        $("#standTypeFilterContainer").html(innerHtmlStr+staticStandTypeHtmlString);
                    }
                }
                $.afui.drawer.show('#right_Filter','right');
       }
    );

    $("#createStandPanel2").on("panelload",function(){
        if(!mapCr) {
            var init_city = commonHelper.getUserBelongedLocation();
            mapCr = new BMap.Map("mapContainerCr");
            mapCr.addEventListener("moveend", mapCr_moveend_event);
            mapCr.addEventListener("click", mapCr_click_event);
            mapCr.centerAndZoom(init_city);
            //initMapLocation(mapCr);
        }
        toastObj  = $.afui.toast({
            message: hint_Message.STAND_CREATION_SET_POINT_HINT,
            position:"bc",
            autoClose:true, //have to click the message to close
            type:"success"
        });

    });

    $(".panel").on("panelload",function(){
        if (currentPanel != "#createStandPanel2") {
            if (toastObj) {
                toastObj.hide();
                toastObj = null;
            }
        }
        if (currentPanel != "#createStandPanel1" && currentPanel != "#createStandPanel2" && currentPanel != "#createStandPanel3" ) {
            var currentCreatedPoiMarker = null;
            var currentCreatedPoint = null;
            if (mapCr)
            {
                mapCr.clearOverlays();
            }
        }

    });

    $("#file").on("change", function(evt){
        inputSeed = (new Date()).getTime();
        var files = evt.target.files;
        for (var i = 0, f; f = files[i]; i++) {
            // Only process image files.
            if (!f.type.match('image.*')) {
                continue;
            }

            fileExtension = f.name.substring(f.name.indexOf("."));
            if (f.size > UPLOAD_IMAGE_MAXSIZE)
            {
                $.afui.toast({
                    message: hint_Message.STAND_IMAGE_UPLOAD_SIZE_EXCEED,
                    position:"bc",
                    autoClose:true, //have to click the message to close
                    type:"success"
                });
                continue;
            }
            var tFile = f;
            uploadSingleStandImage(function(e)
            {

                if (e) {
                    var reader = new FileReader();
                    // Closure to capture the file information.
                    reader.onload = function () {
                            // Render thumbnail.
                            toCreateImageCollection[e] = 0;
                            var imageContentString = generateImagePreviewBox(e, event.target.result);

                            $("#standImageContainer").append(imageContentString);

                        };

                    reader.readAsDataURL(tFile);
                }
                else
                {
                    //上传失败提示
                }
            });
            // Read in the image file as a data URL.

        }
    });



    function searchSecLocation(mapObject)
    {
        $("#resultList").html("");
        $.afui.loadContent("#searchResultListPanel",false,false,"pop");
        var searchString = $("#searchDivInner input").val();
        $("#searchDivResultInner input").val(searchString);
        $("#searchResultListForm").on("submit",function()
                {
                    var searchStringInner = $("#searchDivResultInner input").val();
                    $("#searchInput").val(searchStringInner);

                    searchLocalPosition(searchStringInner,mapObject,$("#resultList"));
                    return false;
                }
        );
        searchLocalPosition(searchString,mapObject,$("#resultList"));
    }

    function searchLocation(mapObject)
    {
        $("#resultList").html("");
        $.afui.loadContent("#searchResultListPanel",false,false,"pop");
        var searchString = $("#searchInput").val();
        $("#searchDivResultInner input").val(searchString);
        $("#searchResultListForm").on("submit",function()
         {
             var searchStringInner = $("#searchDivResultInner input").val();
             $("#searchInput").val(searchStringInner);

             searchLocalPosition(searchStringInner,mapObject,$("#resultList"));
             return false;
         }
        );
        searchLocalPosition(searchString,mapObject,$("#resultList"));
    }

    function searchStand(mapObject)
    {
        $("#resultList").html("");
        transferToPanel("#searchResultListPanel","pop");
        var searchString = $("#searchInput").val();
        $("#searchDivResultInner input").val(searchString);
        $("#searchResultListForm").on("submit",function()
                {
                    var searchStringInner = $("#searchDivResultInner input").val();
                    $("#searchInput").val(searchStringInner);
                    searchPoiNearbyPosition(mapCenterString,mapObject,searchStringInner,$("#resultList"));
                    return false;
                }
        );
        searchPoiNearbyPosition(mapCenterString,mapObject,searchString,$("#resultList"));
    }

// map related =====================================================
    map = new BMap.Map("mapContainer");
    var Json_tap_position; //finger tap position return Json
    var Json_decode_position2address; //get address from position
    var current_map_level;
    initialMapParameter();
    //map.centerAndZoom(new BMap.Point(CONST_POINT_X, CONST_POINT_Y), CONST_DISPLAY_LEVEL);
   // initMapLocation(map);
    map.centerAndZoom("上海");
    var map_dragend_event = function (){

    };
    var map_click_event = function (e){
        var pt = e.point;
        Json_tap_position =
        {
            "point_x":pt.lng ,
            "point_y": pt.lat
        };
        alert(Json_tap_position.point_x + "  " + Json_tap_position.point_y);
        gc.getLocation(pt, function(rs){
            var addComp = rs.addressComponents;
            Json_decode_position2address = {
                "province": addComp.province,
                "city": addComp.city,
                "district": addComp.district,
                "street": addComp.street,
                "streetNumber": addComp.streetNumber
            };
        });
    };
    var map_zoomend_event = function (){
        current_map_level = map.getZoom();
    };

    var map_moveend_event = function (){
        mapCenterString = getMapCenter(map);

        //map.clearOverlays();
       removeMarkersByMarkers(currentDisplayStandsMarks,map);
       searchPoiNearbyPositionDisplay(mapCenterString,"",map,"#standList");
    };
    var map_load_event = function(){
        mapCenterString = getMapCenter(map);
        //searchPoiNearbyPositionDisplay(mapCenterString,"",map,"#standList");
    };

    var mapCr_moveend_event = function(){
        mapCenterString = getMapCenter(mapCr);
        //map.clearOverlays();
        removeMarkersByMarkers(currentDisplayStandsMarks,mapCr);
        searchPoiNearbyPositionDisplay(mapCenterString,"",mapCr,"#standList");
    };

    var mapCr_click_event = function(e){
        var pt = e.point;
        Json_tap_position =
        {
            "point_x":pt.lng ,
            "point_y": pt.lat
        };
        popupCreateStandPointWindow(pt);


    };

    // map.addEventListener("dragend", map_dragend_event);
   // map.addEventListener("click", map_click_event);
    //map.addEventListener("zoomend", map_zoomend_event);
    map.addEventListener("moveend", map_moveend_event);
    map.addEventListener("load", map_load_event);


    function initMapLocation(mapObject)
    {

        var init_city = commonHelper.getUserBelongedLocation();
        var gpsPosition = fetchCurrentGPSPosition();
        if (localStorage.position) {

            currentGPSPosition = localStorage.position;
        }

        if (gpsPosition)
        {
            currentGPSPosition = gpsPosition;
            localStorage.position = currentGPSPosition;
            mapObject.centerAndZoom(transStringToPoint(currentGPSPosition), CONST_DISPLAY_LEVEL);
        }
        else if (currentGPSPosition)
        {
            mapObject.centerAndZoom(transStringToPoint(currentGPSPosition), CONST_DISPLAY_LEVEL);
        }
        else
        {
            mapObject.centerAndZoom(init_city);
        }
    }
    function initialMapParameter()
    {
        iconFood  = new BMap.Icon("./images/food.png", new BMap.Size(24, 35), {
            offset: new BMap.Size(12, 35)
        });
        iconFoodFa  = new BMap.Icon("./images/food_fa.png", new BMap.Size(24, 35), {
            offset: new BMap.Size(12, 35)
        });
        iconToy = new BMap.Icon("./images/toy.png", new BMap.Size(24, 35), {
            offset: new BMap.Size(12, 35)
        });
        iconToyFa = new BMap.Icon("./images/toy_fa.png", new BMap.Size(24, 35), {
            offset: new BMap.Size(12, 35)
        });
        iconCloth= new BMap.Icon("./images/cloth.png", new BMap.Size(24, 35), {
            offset: new BMap.Size(12, 35)
        });
        iconClothFa= new BMap.Icon("./images/cloth_fa.png", new BMap.Size(24, 35), {
            offset: new BMap.Size(12, 35)
        });
        iconDigital= new BMap.Icon("./images/digital.png", new BMap.Size(24, 35), {
            offset: new BMap.Size(12, 35)
        });
        iconDigitalFa= new BMap.Icon("./images/digital_fa.png", new BMap.Size(24, 35), {
            offset: new BMap.Size(12, 35)
        });
        iconLocate= new BMap.Icon("./images/locate.png", new BMap.Size(32, 32), {
            offset: new BMap.Size(16, 32)
        });
    }

    function popupCreateStandPointWindow(e)
    {
        gc.getLocation(e, function(rs){
            var addComp = rs.addressComponents;
            Json_decode_position2address = {
                "province": addComp.province,
                "city": addComp.city,
                "district": addComp.district,
                "street": addComp.street,
                "streetNumber": addComp.streetNumber
            };
            var popupMessage = "";
            popupMessage = popupMessage + "省市区： " +  addComp.province + " " + addComp.city + " " + addComp.district + "<br/>";
            popupMessage = popupMessage + "街道： " +  addComp.street + "<br/>";
            popupMessage = popupMessage + "门牌： " +  addComp.streetNumber + "  附近";

            $.afui.popup({
                title: normal_Text.STAND_CONFIRM_POINT,
                message: popupMessage,
                cancelText: normal_Text.NO,
                cancelCallback: function () {
                },
                doneText: normal_Text.YES,
                doneCallback: function () {
                    if (currentCreatedPoiMarker) {
                        mapCr.removeOverlay(currentCreatedPoiMarker);
                    }
                    currentCreatedPoiMarker = addMarker(e, 0, mapCr, iconLocate);
                    currentCreatedPoint = e.lng + "," + e.lat;
                },
                cancelOnly: false
            });

        });

    }

</script>
</body>
</html>